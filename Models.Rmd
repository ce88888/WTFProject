---
title: "Models"
author: "Christian Endter"
date: "12/01/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


library(MASS)
library(gbm)
library(tidyverse)
library(lubridate)
library(ggplot2)
library(pscl)
library(lme4)
library(glmmTMB)
library(dataPreparation)
library(gbm)
library(caret)
library(ROCR)
# library(ResourceSelection)


```


```{r Data set preparation}
data <- readRDS("KDEN model data all flights.RDS")


### Set 1: Base data (adjust time filter as needed)
### - every line corresponds to a single flight with STRIKE = 1/0
d <- data %>% dplyr::filter(year(DATE) %in% 2014:2018) %>%
    mutate(WEEK = as.factor(isoweek(DATE)), 
           MONTH = as.factor(month(DATE)))
  
### Set 2: Data aggregated by hour
### - every line corresponds to a particular hour on a date with STRIKES = num strikes, and STRIKE = 1/0
d_day_hour <- d %>%
  group_by(`AIRPORT ID`,DATE,RTIME) %>%
  summarise(`FLTS TOTAL` = first(`FLTS TOTAL`), STRIKES = sum(STRIKE),
            BIRDCOUNT = first(BIRDCOUNT),
            TEMP = mean(TEMP,na.rm=TRUE), SLP = mean(SLP, na.rm=TRUE),
            `WIND ANGLE` = mean(`WIND ANGLE`, na.rm=T), `WIND SPEED`= mean(`WIND SPEED`,na.rm=TRUE),
            CLOUDH = mean(CLOUDH, na.rm=T), COVERH = mean(COVERH, na.rm=T),
            VIS = mean(VIS, na.rm=T)) %>%
  mutate(STRIKE = ifelse(STRIKES>0,1,0),
         WEEK = factor(isoweek(DATE), levels=1:53),
         MONTH = factor(month(DATE), levels=1:12))

# d_day_hour$WEEK <- as.factor(d_day_hour$WEEK)
# d_day_hour$MONTH<- as.factor(d_day_hour$MONTH)

### Set 3: Data aggregated by day
### - every line correspondes to a particular date with STRIKES = num strikes, and STRIKE = 1/0 
d_day <- d_day_hour %>%
  group_by(`AIRPORT ID`,DATE) %>%
  summarise(`FLTS TOTAL` = sum(`FLTS TOTAL`), STRIKES = sum(STRIKE),
            BIRDCOUNT = first(BIRDCOUNT),
            TEMP = mean(TEMP,na.rm=TRUE), SLP = mean(SLP, na.rm=TRUE),
            `WIND ANGLE` = mean(`WIND ANGLE`, na.rm=T), `WIND SPEED`= mean(`WIND SPEED`,na.rm=TRUE),
            CLOUDH = mean(CLOUDH, na.rm=T), COVERH = mean(COVERH, na.rm=T),
            VIS = mean(VIS, na.rm=T)) %>%
  mutate(STRIKE = ifelse(STRIKES>0,1,0),
         WEEK = factor(isoweek(DATE), levels=1:53),
         MONTH = factor(month(DATE), levels=1:12))

### Quick - look
### Heavily unbalanced base set
table(d$STRIKE)

### Heavily zeroinflated counts
table(d_day_hour$STRIKES)
table(d_day$STRIKES)
```


```{r Logistic regression - DAY/HOUR}

m_day_hour_notime <- glm(STRIKE ~ `FLTS TOTAL` + `WIND SPEED` + `WIND ANGLE` + TEMP + SLP + BIRDCOUNT + 
                       CLOUDH + COVERH + VIS, data = d_day_hour,family=binomial(link='logit'))
summary(m_day_hour_notime)

m_day_hour_wfactor <- glm(STRIKE ~ `FLTS TOTAL` + `WIND SPEED` + `WIND ANGLE` + TEMP + SLP + BIRDCOUNT + 
                       CLOUDH + COVERH + VIS + WEEK, data = d_day_hour,family=binomial(link='logit'))
summary(m_day_hour_wfactor)

m_day_hour_mfactor <- glm(STRIKE ~ `FLTS TOTAL` + `WIND SPEED` + `WIND ANGLE` + TEMP + SLP + BIRDCOUNT + 
                       CLOUDH + COVERH + VIS + MONTH, data = d_day_hour,family=binomial(link='logit'))
summary(m_day_hour_mfactor)

### too much noise in hourly information?
```

```{r Logistic regression - DAY}

m_day_notime <- glm(STRIKE ~ `FLTS TOTAL` + `WIND SPEED` + `WIND ANGLE` + TEMP + SLP + BIRDCOUNT + 
                       CLOUDH + COVERH + VIS, data = d_day,family=binomial(link='logit'))
summary(m_day_notime)

m_day_wfactor <- glm(STRIKE ~ `FLTS TOTAL` + `WIND SPEED` + `WIND ANGLE` + TEMP + SLP + BIRDCOUNT + 
                       CLOUDH + COVERH + VIS + WEEK, data = d_day,family=binomial(link='logit'))
summary(m_day_wfactor)

m_day_mfactor <- glm(STRIKE ~ `FLTS TOTAL` + `WIND SPEED` + `WIND ANGLE` + TEMP + SLP + BIRDCOUNT + 
                       CLOUDH + COVERH + VIS + MONTH, data = d_day,family=binomial(link='logit'))
summary(m_day_mfactor)

```

```{r Count Models - DAY}

m <-glmer.nb(STRIKES ~ `FLTS TOTAL` +  (1|MONTH), data = d_day)

m <-glm.nb(STRIKES ~`FLTS TOTAL` + VIS + TEMP + COVERH + CLOUDH + SLP + BIRDCOUNT +
             `WIND SPEED` + `WIND ANGLE` + as.factor(WEEK), data = d_day_hour)

m_count_day_notime <- hurdle(STRIKES ~ SLP + BIRDCOUNT + `FLTS TOTAL` + `WIND SPEED` + `WIND ANGLE` + TEMP + 
                              CLOUDH + COVERH + VIS, 
                               data = d_day, dist="negbin")
m_count_day_notime <- glm.nb(STRIKES ~ `FLTS TOTAL` + `WIND SPEED` + `WIND ANGLE` + TEMP + 
                                 SLP + BIRDCOUNT + CLOUDH + COVERH + VIS, 
                               data = d_day)
summary(m_count_day_notime)
#### Seems that models very sensitive to scale of variables ...
#### When using hurdle/zeroinfl with "negbin", it seems that theta goes very large, which would indicate that poisson model can be used (as it woudl approximate it) -> same above
# m_count_day_mfactor <- hurdle(STRIKES ~ `FLTS TOTAL` + `WIND SPEED` + `WIND ANGLE` + TEMP + 
#                                  SLP + BIRDCOUNT + CLOUDH + COVERH + VIS + MONTH,
#                                data = dddd, dist="poisson")

# m_count_day_mfactor <- glmer.nb(STRIKES ~ `FLTS TOTAL` + `WIND SPEED` + `WIND ANGLE` + TEMP + 
#                                  SLP + BIRDCOUNT + CLOUDH + COVERH + VIS + (1|MONTH),
#                                data = dddd)

### Even after scaling .. still large theta
ds_day <- fastScale(d_day)
ds_day$STRIKES <- d_day$STRIKES
m_count_day_wfactor <- glm(STRIKES ~ `FLTS TOTAL` + `WIND SPEED` + `WIND ANGLE` + TEMP + 
                                 SLP + BIRDCOUNT + CLOUDH + COVERH + VIS + WEEK, family= "poisson",
                               data = ds_day)
m_count_day_wfactor <- glm.nb(STRIKES ~ `FLTS TOTAL` + `WIND SPEED` + `WIND ANGLE` + TEMP + 
                                 SLP + BIRDCOUNT + CLOUDH + COVERH + VIS + WEEK,
                               data = ds_day)
summary(m_count_day_wfactor)
        
### Theta smaller, so Nb probably better       
m_count_day_mfactor <- glm(STRIKES ~ `FLTS TOTAL` + `WIND SPEED` + `WIND ANGLE` + TEMP + 
                                 SLP + BIRDCOUNT + CLOUDH + COVERH + VIS + MONTH, 
                               data = ds_day, family="poisson")
m_count_day_mfactor <- glm.nb(STRIKES ~ `FLTS TOTAL` + `WIND SPEED` + `WIND ANGLE` + TEMP + 
                                 SLP + BIRDCOUNT + CLOUDH + COVERH + VIS + MONTH, 
                               data = ds_day)
m_count_day_mfactor <- glmer.nb(STRIKES ~ `FLTS TOTAL` + `WIND SPEED` + `WIND ANGLE` + TEMP + 
                                 SLP + BIRDCOUNT + CLOUDH + COVERH + VIS + 
                                  (1+ VIS|MONTH) , 
                               data = ds_day)


summary(m_count_day_mfactor)



```


```{r Trees?}

tm <- gbm(STRIKES ~`FLTS TOTAL` + `WIND SPEED` + `WIND ANGLE` + TEMP + 
                                 SLP + BIRDCOUNT + CLOUDH + VIS, data = d_day)

```


dx <- d %>% dplyr::filter(DATE == "2014-01-01") 

%>% group_by(`AIRPORT ID`, DATE) %>% 
  summarise(RTIME=mean(RTIME),STRIKES = sum(STRIKE, na.rm=T), `FLTS TOTAL`=sum(`FLTS TOTAL`, na.rm=T), 
            TEMP = mean(TEMP,na.rm=TRUE),
            `WIND ANGLE` = mean(`WIND ANGLE`, na.rm=T), `WIND SPEED`= mean(`WIND SPEED`,na.rm=TRUE),
            BIRDS = sum(BIRDCOUNT), CLOUDH = mean(CLOUDH, na.rm=T))

day_strike_binary <- d %>% dplyr::filter(year(DATE) %in% 2014:2019) %>%
  group_by(`AIRPORT ID`, DATE) %>% 
  summarise(RTIME=mean(RTIME),STRIKES = sum(STRIKE, na.rm=T), `FLTS TOTAL`=mean(`FLTS TOTAL`, na.rm=T), 
            TEMP = mean(TEMP,na.rm=TRUE),
            `WIND ANGLE` = mean(`WIND ANGLE`, na.rm=T), `WIND SPEED`= mean(`WIND SPEED`,na.rm=TRUE),
            BIRDS = sum(BIRDCOUNT), CLOUDH = mean(CLOUDH, na.rm=T))
  
day_strike_binary <- day_strike_binary %>% mutate(YN = if_else(STRIKES>0,1,0))

m <- glm(YN ~ `FLTS TOTAL` + `WIND SPEED` + TEMP + `WIND ANGLE` + BIRDS + CLOUDH + as.factor(week(DATE)),
         data = day_strike_binary,family=binomial(link='logit'))
mzi <- zeroinfl(STRIKES ~ `FLTS TOTAL` + `WIND SPEED` + TEMP + `WIND ANGLE` + BIRDS + CLOUDH + as.factor(week(DATE)),
         data = day_strike_binary)

### DON'T RUN ANY OF THIS ...  takes too long and has issues

m <- glm.nb(STRIKE ~ `FLTS TOTAL` + `WIND SPEED` + TEMP, data = d, control = list(maxit = 25, epsilon=0.000001, trace=FALSE))


d_byday <- d %>% dplyr::filter(year(DATE) %in% 2014:2019) %>%
  group_by(`AIRPORT ID`, DATE) %>% 
  summarise(RTIME=mean(RTIME),STRIKES = sum(STRIKE, na.rm=T), `FLTS TOTAL`=sum(`FLTS TOTAL`, na.rm=T), 
            TEMP = mean(TEMP,na.rm=TRUE),`WIND SPEED`=mean(`WIND SPEED`,na.rm=TRUE))

m <- glm.nb(STRIKES ~ `FLTS TOTAL` + TEMP + as.factor(week(DATE)), data = dbyday)
mh <- hurdle(STRIKE ~ `FLTS TOTAL` + TEMP + as.factor(week(DATE)), data = dplyr::filter(d,year(DATE) %in% 2000:2010))

model <- glm(Survived ~.,family=binomial(link='logit'),data=train)
```


```{r Classifier - Forest GBM}

```



# Count Models

```{r Initial Analysis}

# Number of strikes per week (note this is different from the ave strikes per week aggregated by days)

master <- readRDS("KDEN complete.RDS")
mw <- master %>% 
  dplyr::filter(DATE > "1994-08-01") %>% 
  mutate(WEEK = isoweek(DATE)) %>% 
  group_by(YEAR=year(DATE), WEEK) %>% 
  summarise(x=sum(STRIKE)) %>% 
  group_by(WEEK) %>% 
  summarise(NWEEKS=n(),STRIKES=sum(x), RATIO=STRIKES/NWEEKS)


# Map back to master file
master <- master %>% mutate(WEEK = isoweek(DATE))
mw <- dplyr::select(mw, WEEK, RATIO)
master <- left_join(master,mw, by=c("WEEK"="WEEK"))

x <- master %>% group_by(WEEK) %>% summarise(RATIO = mean(RATIO))
mean(x$RATIO)
sd(x$RATIO)


master <- master %>% group_by(DATE, RTIME) %>% summarise
m <- lm(RATIO ~ TEMP + as.factor(week(DATE)), data=master)

# 53 weeks? Seems part of ISO standard because Jan 1st not always a Monday
mw <- master %>% group_by(DATE, WEEK = week(DATE)) 

## Calculate the probability of a strike ... WE SEEM TO LOSE SOME ROWS IN THIS AGGREGATION - SAME RUNWAY STRIKES?
# NOTE, CAN'T USE n() as it counts records and thus includes days with no strikes (=NA)
masterl <- master %>% 
  group_by(`AIRPORT ID`, DATE,TD, RUNWAY) %>%
  summarise(STRIKES = sum(STRIKE), TOTAL = sum(TOTAL), ARRIVALS = sum(ARRIVALS), DEPARTURES = sum(DEPARTURES),
            STRIKEP = STRIKES/TOTAL)
```

```{r Graphs}
x <- master %>% group_by(WEEK) %>% summarise(RATIO = mean(RATIO))
ggplot(x, aes(x=WEEK,y=RATIO, group=WEEK)) + geom_boxplot()

master <- master %>% mutate(WEEK = week(DATE))

m <- gbm(STRIKE ~ WEEK + TOTAL,data=master)

```

